commit c00e881a450fc465e60f41bd47ea6396a87f3eef
Author: Steven Liu <liuqi05@kuaishou.com>
Date:   Fri May 29 11:39:05 2020 +0800

    avformat/hls: check segment duration value of EXTINF
    
    fix ticket: 8673
    set the default EXTINF duration to 1ms if duration is smaller than 1ms
    
    Signed-off-by: Steven Liu <lq@chinaffmpeg.org>
    (cherry picked from commit 9dfb19baeb86a8bb02c53a441682c6e9a6e104cc)

diff --git a/libavformat/hls.c b/libavformat/hls.c
index 8c12fcef77..fb2af90b92 100644
--- a/libavformat/hls.c
+++ b/libavformat/hls.c
@@ -873,8 +873,6 @@ static int parse_playlist(HLSContext *c, const char *url,
                     ret = AVERROR(ENOMEM);
                     goto fail;
                 }
-                seg->duration = duration;
-                seg->key_type = key_type;
                 if (has_iv) {
                     memcpy(seg->iv, iv, sizeof(iv));
                 } else {
@@ -904,6 +902,13 @@ static int parse_playlist(HLSContext *c, const char *url,
                     goto fail;
                 }
 
+                if (duration < 0.001 * AV_TIME_BASE) {
+                    av_log(c->ctx, AV_LOG_WARNING, "Cannot get correct #EXTINF value of segment %s,"
+                                    " set to default value to 1ms.\n", seg->url);
+                    duration = 0.001 * AV_TIME_BASE;
+                }
+                seg->duration = duration;
+                seg->key_type = key_type;
                 dynarray_add(&pls->segments, &pls->n_segments, seg);
                 is_segment = 0;
 
